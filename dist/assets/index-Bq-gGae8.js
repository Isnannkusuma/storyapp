(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class v{constructor(){this.baseUrl="https://story-api.dicoding.dev/v1",this.token=localStorage.getItem("token")||null,this.VAPID_PUBLIC_KEY="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}async login(e,t){const s=await(await fetch(`${this.baseUrl}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})})).json();if(s.error)throw new Error(s.message);return this.token=s.loginResult.token,localStorage.setItem("token",this.token),s}async register(e,t,i){const a=await(await fetch(`${this.baseUrl}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:i})})).json();if(a.error)throw new Error(a.message);return a}async getStories(){const t=await(await fetch(`${this.baseUrl}/stories`,{headers:{Authorization:`Bearer ${this.token}`}})).json();if(t.error)throw new Error(t.message);return t.listStory}async getStoryDetail(e){try{const i=await(await fetch(`${this.baseUrl}/stories/${e}`,{headers:{Authorization:`Bearer ${this.token}`}})).json();if(i.error)throw new Error(i.message);return i.story}catch(t){throw t}}async addStory(e,t,i,s){const a=new FormData;a.append("description",e),a.append("photo",t),i&&s&&(a.append("lat",i),a.append("lon",s));const l=await(await fetch(`${this.baseUrl}/stories`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:a})).json();if(l.error)throw new Error(l.message);return l}async subscribePushNotification(e){console.log("subscribePushNotification dipanggil");const t=localStorage.getItem("token"),i={endpoint:e.endpoint,keys:{p256dh:e.getKey("p256dh")?btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("p256dh")))):"",auth:e.getKey("auth")?btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("auth")))):""}},s=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)}),a=await s.json();if(console.log("Subscribe API response:",a),!s.ok)throw new Error("Gagal subscribe push notification");return a}async subscribePush(){if(console.log("subscribePush dipanggil"),!("serviceWorker"in navigator)||!("PushManager"in window))throw new Error("Browser tidak mendukung Push Notification!");const e=await navigator.serviceWorker.ready;if(await Notification.requestPermission()!=="granted")throw new Error("Izin notifikasi ditolak!");let i=await e.pushManager.getSubscription();i||(i=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(this.VAPID_PUBLIC_KEY)})),await this.subscribePushNotification(i),console.log("subscribePushNotification selesai")}async unsubscribePush(){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw new Error("Browser tidak mendukung Push Notification!");const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!t)throw new Error("Belum berlangganan notifikasi.");const i=localStorage.getItem("token"),s=t.endpoint,a=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({endpoint:s})}),r=await a.json();if(console.log("Unsubscribe response:",r),!a.ok||r.error)throw new Error(r.message||"Gagal unsubscribe push notification");await t.unsubscribe()}urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),i=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),s=atob(i),a=new Uint8Array(s.length);for(let r=0;r<s.length;++r)a[r]=s.charCodeAt(r);return a}logout(){this.token=null,localStorage.removeItem("token")}isLoggedIn(){return!!this.token}}class f{constructor(){this.currentPage=null,this.navLinks=document.getElementById("nav-links"),this.mainContent=document.getElementById("main-content"),this.map=null,this.addStoryMap=null,this.currentStream=null,this.selectedLocation=null,this.capturedPhotoBlob=null}renderNavLinks(e){const t=document.getElementById("nav-links");t&&(t.innerHTML="",e?t.innerHTML=`
        <a href="#stories" class="nav-link">Daftar Cerita</a>
        <a href="#add-story" class="nav-link">Buat Cerita Baru</a>
        <a href="#saved-stories" class="nav-link">Cerita Tersimpan</a>
        <a href="#" id="logout-btn" class="nav-link">Logout</a>
      `:t.innerHTML=`
        <a href="#login" class="nav-link">Login</a>
        <a href="#register" class="nav-link">Register</a>
      `)}setPresenter(e){this.presenter=e}showPage(e){document.querySelectorAll(".page").forEach(i=>{i.style.display="none",i.classList.remove("active")});const t=document.getElementById(e);t&&(t.style.display="",t.classList.add("active"))}updateNavigation(){window.storyModel.isLoggedIn()?this.navLinks.innerHTML=`
                <a href="#stories" class="nav-link">Cerita</a>
                <a href="#add-story" class="nav-link">Tambah Cerita</a>
                <a href="#saved-stories" class="nav-link">Cerita Tersimpan</a>
                <a href="#" class="nav-link" id="logout-btn">Logout</a>
            `:this.navLinks.innerHTML=`
                <a href="#login" class="nav-link">Login</a>
                <a href="#register" class="nav-link">Register</a>
            `,document.querySelectorAll(".nav-link").forEach(i=>{i.classList.remove("active"),i.getAttribute("href")===`#${this.currentPage.replace("-page","")}`&&i.classList.add("active")})}showAlert(e,t="info"){const i=document.createElement("div");i.className=`alert alert-${t}`,i.textContent=e;const s=document.querySelector(".page.active");s.insertBefore(i,s.firstChild),setTimeout(()=>{i.remove()},5e3)}renderStories(e){const t=document.getElementById("stories-list");if(!t)return;if(!e||e.length===0){t.innerHTML="<p>Belum ada cerita yang tersedia.</p>";return}const i=document.createElement("div");i.className="stories-grid",e.forEach(s=>{const a=document.createElement("article");a.className="story-card",a.innerHTML=`
        <img src="${s.photoUrl}" alt="${s.description}" class="story-image" loading="lazy">
        <div class="story-content">
            <h2 class="story-title">${s.name}</h2>
            <p class="story-description">${s.description}</p>
            <div class="story-meta">
                <span>ID: ${s.id}</span>
                <span>${new Date(s.createdAt).toLocaleDateString("id-ID")}</span>
            </div>
            <button class="btn-simpan-story" style="margin-top:8px;">Simpan Cerita Ini</button>
        </div>
    `,a.addEventListener("click",l=>{l.target.classList.contains("btn-simpan-story")||(this.presenter?this.presenter.handleStoryDetail(s.id):alert("Presenter belum di-set!"))}),a.querySelector(".btn-simpan-story").addEventListener("click",l=>{l.stopPropagation(),this.presenter&&this.presenter.handleSaveStory?this.presenter.handleSaveStory(s):alert("Fitur simpan cerita belum tersedia!")}),i.appendChild(a)}),t.innerHTML="",t.appendChild(i),this.initializeStoriesMap(e)}renderStoryDetail(e){const t=document.getElementById("story-detail-container");t.innerHTML=`
        <article class="story-detail">
            <img src="${e.photoUrl}" alt="${e.description}" class="story-image" loading="lazy">
            <div class="story-content">
                <h2>${e.name}</h2>
                <p>${e.description}</p>
                <p><strong>Dibuat:</strong> ${new Date(e.createdAt).toLocaleString("id-ID")}</p>
                ${e.lat&&e.lon?`<p><strong>Lokasi:</strong> (${e.lat}, ${e.lon})</p>`:""}
            </div>
        </article>
    `}initializeStoriesMap(e){const t=document.getElementById("stories-map");t.innerHTML='<div id="map"></div>',this.map=L.map("map").setView([-6.2,106.816666],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(this.map),e.forEach(i=>{i.lat&&i.lon&&L.marker([i.lat,i.lon]).addTo(this.map).bindPopup(`
                    <div style="max-width: 200px;">
                        <img src="${i.photoUrl}" alt="${i.description}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                        <h3 style="margin: 0 0 4px 0; font-size: 14px;">${i.name}</h3>
                        <p style="margin: 0; font-size: 12px; color: #666;">${i.description}</p>
                    </div>
                `)})}initializeAddStoryMap(){this.addStoryMap&&this.addStoryMap.remove(),this.addStoryMap=L.map("add-story-map").setView([-6.2,106.816666],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(this.addStoryMap);let e=null;this.addStoryMap.on("click",t=>{const i=t.latlng.lat,s=t.latlng.lng;e&&this.addStoryMap.removeLayer(e),e=L.marker([i,s]).addTo(this.addStoryMap),e.bindPopup("Lokasi dipilih").openPopup(),this.selectedLocation={lat:i,lon:s},document.getElementById("story-lat").value=i,document.getElementById("story-lon").value=s})}async initializeCamera(){const e=document.getElementById("camera-feed"),t=document.getElementById("start-camera"),i=document.getElementById("capture-photo"),s=document.getElementById("retake-photo"),a=document.getElementById("photo-canvas"),r=document.getElementById("captured-photo"),l=document.getElementById("file-input");t.addEventListener("click",async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Browser tidak mendukung akses kamera");t.disabled=!0,t.textContent="Memulai kamera...";let o=null;const d=[{video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}},{video:{facingMode:"user",width:{ideal:640},height:{ideal:480}}},{video:{width:{ideal:640},height:{ideal:480}}},{video:!0}];for(let c of d)try{o=await navigator.mediaDevices.getUserMedia(c);break}catch(u){console.log("Constraint failed:",c,u.message);continue}if(!o)throw new Error("Tidak dapat mengakses kamera dengan semua konfigurasi");this.currentStream=o,e.srcObject=o,await new Promise((c,u)=>{e.onloadedmetadata=()=>{e.play().then(c).catch(u)},e.onerror=u,setTimeout(()=>u(new Error("Timeout saat memulai video")),1e4)}),e.style.display="block",t.style.display="none",i.style.display="inline-block"}catch(o){console.error("Camera error:",o),t.disabled=!1,t.textContent="Buka Kamera",this.showCameraFallback(),this.showAlert("Tidak dapat mengakses kamera: "+o.message+'. Gunakan tombol "Pilih File" sebagai alternatif.',"warning")}}),i.addEventListener("click",()=>{try{if(e.videoWidth===0||e.videoHeight===0)throw new Error("Video belum siap");const o=a.getContext("2d");a.width=e.videoWidth,a.height=e.videoHeight,o.drawImage(e,0,0),a.toBlob(d=>{if(!d){this.showAlert("Gagal mengambil foto","error");return}const c=URL.createObjectURL(d);r.src=c,r.style.display="block",this.capturedPhotoBlob=d,e.style.display="none",i.style.display="none",s.style.display="inline-block",this.stopCamera()},"image/jpeg",.8)}catch(o){this.showAlert("Gagal mengambil foto: "+o.message,"error")}}),s.addEventListener("click",()=>{r.style.display="none",s.style.display="none",t.style.display="inline-block",t.disabled=!1,t.textContent="Buka Kamera",this.capturedPhotoBlob=null,r.src.startsWith("blob:")&&URL.revokeObjectURL(r.src)}),l.addEventListener("change",o=>{const d=o.target.files[0];if(d&&d.type.startsWith("image/")){this.capturedPhotoBlob=d;const c=URL.createObjectURL(d);r.src=c,r.style.display="block",e.style.display="none",t.style.display="none",i.style.display="none",s.style.display="inline-block"}})}showCameraFallback(){const e=document.getElementById("file-input"),t=document.getElementById("file-input-label");e.style.display="block",t.style.display="block"}stopCamera(){this.currentStream&&(this.currentStream.getTracks().forEach(e=>e.stop()),this.currentStream=null)}resetAddStoryForm(){document.getElementById("add-story-form").reset(),document.getElementById("captured-photo").style.display="none",document.getElementById("camera-feed").style.display="none",document.getElementById("start-camera").style.display="inline-block",document.getElementById("capture-photo").style.display="none",document.getElementById("retake-photo").style.display="none",this.capturedPhotoBlob=null,this.selectedLocation=null,this.stopCamera(),this.addStoryMap&&(this.addStoryMap.remove(),this.addStoryMap=null)}showLoading(e=!0){document.querySelectorAll(".loading").forEach(i=>{i.style.display=e?"block":"none"})}showStoryModal(e){const t=document.getElementById("story-modal"),i=document.getElementById("modal-content");i.innerHTML=`
    <img src="${e.photoUrl}" alt="${e.description}" style="width:100%;border-radius:8px;">
    <h2 style="margin-top:16px;">${e.name}</h2>
    <p>${e.description}</p>
    <p><strong>Dibuat:</strong> ${new Date(e.createdAt).toLocaleString("id-ID")}</p>
    ${e.lat&&e.lon?`<p><strong>Lokasi:</strong> (${e.lat}, ${e.lon})</p>`:""}
  `,t.style.display="block",document.getElementById("close-modal").onclick=()=>{t.style.display="none"},t.onclick=function(s){s.target===t&&(t.style.display="none")}}renderSavedStories(e){const t=document.getElementById("saved-stories-container");if(t.innerHTML="",!e.length){t.innerHTML="<p>Tidak ada cerita tersimpan.</p>";return}e.forEach(i=>{const s=document.createElement("div");s.className="saved_story_card",s.innerHTML=`
        <img src="${i.photoUrl}" alt="${i.title}" />
        <h3>${i.title}</h3>
        <p>${i.body}</p>
        <button class="btn-delete-saved" data-id="${i.id}">Hapus</button>
      `,s.addEventListener("click",a=>{a.target.classList.contains("btn-delete-saved")||this.presenter&&this.presenter.showSavedStoryDetail&&this.presenter.showSavedStoryDetail(i)}),s.querySelector(".btn-delete-saved").addEventListener("click",a=>{a.stopPropagation(),this.presenter&&this.presenter.handleDeleteSavedStory&&this.presenter.handleDeleteSavedStory(i.id)}),t.appendChild(s)})}initializePushControls(){const e=document.getElementById("btn-subscribe-push"),t=document.getElementById("btn-unsubscribe-push");e&&e.addEventListener("click",()=>{console.log("Tombol subscribe diklik"),this.presenter&&this.presenter.handleSubscribePush()}),t&&t.addEventListener("click",()=>{this.presenter&&this.presenter.handleUnsubscribePush()})}}const b="myAppDB",h="savedData";function g(){return new Promise((n,e)=>{const t=indexedDB.open(b,1);t.onupgradeneeded=function(i){const s=i.target.result;s.objectStoreNames.contains(h)||s.createObjectStore(h,{keyPath:"id"})},t.onsuccess=function(i){n(i.target.result)},t.onerror=function(i){e(i.target.error)}})}async function S(n){const t=(await g()).transaction(h,"readwrite");return t.objectStore(h).put(n),t.complete}async function w(){const n=await g();return new Promise(e=>{const i=n.transaction(h).objectStore(h).getAll();i.onsuccess=()=>e(i.result)})}async function k(n){const e=await g();return new Promise((t,i)=>{const r=e.transaction(h,"readwrite").objectStore(h).delete(n);r.onsuccess=()=>t(),r.onerror=l=>i(l.target.error)})}class E{constructor(e,t){this.model=e,this.view=t,this.init()}init(){this.setupEventListeners(),this.checkAuthStatus()}setupEventListeners(){document.addEventListener("click",e=>{if(e.target.classList.contains("nav-link")){e.preventDefault();const t=e.target.getAttribute("href");if(t==="#"&&e.target.id==="logout-btn")this.handleLogout();else if(t!=null&&t.startsWith("#")){const i=t.substring(1)+"-page";this.view.showPage(i),i==="stories-page"?this.loadStories():i==="add-story-page"?(this.view.initializeAddStoryMap(),this.view.initializeCamera()):i==="saved-stories-page"&&this.showSavedStories()}}}),document.addEventListener("submit",e=>{e.preventDefault(),e.target.id==="login-form"?this.handleLogin(e.target):e.target.id==="register-form"?this.handleRegister(e.target):e.target.id==="add-story-form"&&this.handleAddStory(e.target)})}checkAuthStatus(){this.model.isLoggedIn()?(this.view.renderNavLinks(!0),this.view.showPage("stories-page"),this.loadStories()):(this.view.renderNavLinks(!1),this.view.showPage("login-page"))}async handleLogin(e){const t=e.email.value,i=e.password.value;if(!t||!i)return this.view.showAlert("Email dan password harus diisi","error");try{this.view.showLoading(!0),await this.model.login(t,i),this.view.showAlert("Login berhasil!","success"),this.view.showPage("stories-page"),this.view.renderNavLinks(!0),this.loadStories()}catch(s){this.view.showAlert("Login gagal: "+s.message,"error")}finally{this.view.showLoading(!1)}}async handleRegister(e){const t=e.name.value,i=e.email.value,s=e.password.value;if(!t||!i||!s)return this.view.showAlert("Semua field harus diisi","error");if(s.length<8)return this.view.showAlert("Password minimal 8 karakter","error");try{this.view.showLoading(!0),await this.model.register(t,i,s),this.view.showAlert("Registrasi berhasil! Silakan login.","success"),this.view.showPage("login-page"),e.reset()}catch(a){this.view.showAlert("Registrasi gagal: "+a.message,"error")}finally{this.view.showLoading(!1)}}async loadStories(){try{this.view.showLoading(!0);let e;try{e=await this.model.getStories()}catch(t){if(e=await w(),!e||e.length===0)throw t;this.view.showAlert("Menampilkan data offline","info")}this.view.renderStories(e)}catch(e){this.view.showAlert("Gagal memuat cerita: "+e.message,"error")}finally{this.view.showLoading(!1)}}async handleAddStory(e){const t=e.description.value,i=e.lat.value,s=e.lon.value;if(!t)return this.view.showAlert("Deskripsi harus diisi","error");if(!this.view.capturedPhotoBlob)return this.view.showAlert("Foto harus diambil atau dipilih","error");try{this.view.showLoading(!0),await this.model.addStory(t,this.view.capturedPhotoBlob,i||null,s||null),this.view.showAlert("Cerita berhasil ditambahkan!","success"),this.view.resetAddStoryForm(),this.view.showPage("stories-page"),this.loadStories()}catch(a){this.view.showAlert("Gagal menambahkan cerita: "+a.message,"error")}finally{this.view.showLoading(!1)}}async handleStoryDetail(e){try{this.view.showLoading(!0);const t=await this.model.getStoryDetail(e);this.view.renderStoryDetail(t),this.view.showPage("story-detail-page")}catch(t){this.view.showAlert("Gagal memuat detail cerita: "+t.message,"error")}finally{this.view.showLoading(!1)}}handleLogout(){this.model.logout(),this.view.showAlert("Logout berhasil","success"),this.view.showPage("login-page"),this.view.renderNavLinks(!1)}async handleStoryDetail(e){try{this.view.showLoading(!0);const t=await this.model.getStoryDetail(e);this.view.showStoryModal(t)}catch(t){this.view.showAlert("Gagal memuat detail cerita: "+t.message,"error")}finally{this.view.showLoading(!1)}}async handleSaveStory(e){try{await S({id:e.id,title:e.name,body:e.description,date:e.createdAt,photoUrl:e.photoUrl}),this.view.showAlert("Cerita berhasil disimpan!")}catch{this.view.showAlert("Gagal menyimpan cerita!","error")}}async showSavedStories(){this.view.showPage("saved-stories-page"),await new Promise(t=>requestAnimationFrame(t));const e=await w();this.view.renderSavedStories(e)}async handleDeleteSavedStory(e){try{await k(e),this.view.showAlert("Cerita berhasil dihapus!"),this.showSavedStories()}catch{this.view.showAlert("Gagal menghapus cerita!","error")}}showSavedStoryDetail(e){this.view.showPage("story-detail-page"),this.view.renderStoryDetail(e)}async handleSubscribePush(){try{console.log("handleSubscribePush dipanggil"),await this.model.subscribePush(),this.view.showAlert("Berhasil subscribe push notification!","success")}catch(e){this.view.showAlert("Gagal subscribe push notification: "+e.message,"error")}}async handleUnsubscribePush(){try{await this.model.unsubscribePush(),this.view.showAlert("Berhasil unsubscribe push notification!","success")}catch(e){this.view.showAlert("Gagal unsubscribe push notification: "+e.message,"error")}}}const P=new v,p=new f,m=new E(P,p);p.setPresenter(m);m.init();p.initializePushControls();const y=document.getElementById("nav-saved-stories");y&&y.addEventListener("click",n=>{n.preventDefault(),m.showSavedStories()});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").then(n=>{console.log("Service worker registered!",n)}).catch(n=>{console.error("Service worker registration failed:",n)})});async function B(n,e){const i=await(await fetch("https://story-api.dicoding.dev/v1/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:e})})).json();i.loginResult&&i.loginResult.token?(localStorage.setItem("accessToken",i.loginResult.token),alert("Login berhasil!")):alert("Login gagal!")}document.getElementById("login-form").addEventListener("submit",async function(n){n.preventDefault();const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value;await B(e,t)});
